# 3. Программирование общего назначения

Модель программирования общего назначения включает регистры общего назначения (РОН), целочисленные инструкции и операнды, использующие РОН, методы управления потоком программ, методы оптимизации памяти и ввода-вывода. Эта модель программирования включает в себя оригинальную архитектуру x86 с целочисленным программированием, а также 64-битные расширения и несколько дополнительных инструкций. В этой главе описаны только инструкции и ресурсы прикладного программирования. Целочисленные инструкции, обычно используемые в системном программировании, включая все привилегированные инструкции, описаны в томе 2, вместе с другими темами системного программирования.

Модель программирования общего назначения в той или иной степени используется практически всеми программами, включая программы, состоящие в основном из 256- или 128-битных медиа-инструкций, 64-битных медиа-инструкций, инструкций x87 с плавающей точкой или системных инструкций. По этой причине понимание модели программирования общего назначения необходимо для любой работы по программированию с использованием набора инструкций AMD64 архитектуры.

## 3.1 Регистры

На рисунке 3-1 на странице 24 показан обзор регистров, используемых при программировании приложений общего назначения. К ним относятся регистры общего назначения (GPR), сегментные регистры, регистр флагов, и регистр указателей инструкций. Количество и ширина доступных регистров зависит от режима работы.

Регистры и диапазоны регистров, затененные светло-серым цветом на рисунке 3-1 на странице 24, доступны только в 64-битном режиме. Регистры, затененные темно-серым цветом, доступны только в унаследованном режиме и режиме совместимости. Так, в 64-битном режиме 32-битные регистры общего назначения, флаги и указатели команд, доступные в унаследованном режиме и режиме совместимости, расширены до 64-битной ширины, доступны восемь новых GPR, а сегментные регистры DS, ES и SS игнорируются.

При наименовании регистров, если речь идет о нескольких ширинах регистров, используется строчная буква r. Например, обозначение rAX относится к 16-битному AX, 32-битному EAX или 64-битному RAX регистру, в зависимости от эффективного размера операнда инструкции.

<img src="Pasted image 20250629190015.png">

### 3.1.1 Устаревшие регистры

В режимах legacy и compatibility доступны все регистры legacy x86. На рисунке 3-2 на странице 25 показан подробный вид регистров GPR, флагов и указателей инструкций.

<img src="Pasted image 20250629190129.png">

К устаревшим GPRs относятся:
- Восемь 8-битных регистров (AH, AL, BH, BL, CH, CL, DH, DL).
- Восемь 16-битных регистров (AX, BX, CX, DX, DI, SI, BP, SP).
- Восемь 32-битных регистров (EAX, EBX, ECX, EDX, EDI, ESI, EBP, ESP).

Размер регистра, используемого инструкцией, зависит от эффективного размера операнда или, для некоторых инструкций, от опкода, размера адреса или размера стека. На рисунке 3-2 16-битные и 32-битные регистры закодированы как от 0 до 7. Для опкодов, задающих байтовый операнд, регистры, закодированные с 0 по 3, относятся к младшим байтовым регистрам (AL, BL, CL, DL), а регистры, закодированные с 4 по 7, - к старшим байтовым регистрам (AH, BH, CH, DH).

16-битный регистр FLAGS, который также является младшими 16 битами 32-битного регистра EFLAGS, показанного на рисунке 3-2, содержит биты управления и состояния, доступные для прикладного программного обеспечения, как описано в разделе 3.1.4, «Регистр флагов», на странице 34. 16-битный регистр указателя инструкции IP или 32-битный регистр указателя инструкции EIP содержит адрес следующей выполняемой инструкции, как описано в разделе 2.5, «Указатель инструкции», на странице 20.

### 3.1.2 64-битный режим регистров

В 64-битном режиме к восьми старым GPR добавляются восемь новых, все 16 GPR имеют ширину 64 бита, а младшие байты всех регистров доступны. На рисунке 3-3 на странице 27 показаны GPR, регистр флагов и регистр указателя инструкции, доступные в 64-битном режиме. К GPR относятся:

- Шестнадцать 8-битных регистров младшего байта (AL, BL, CL, DL, SIL, DIL, BPL, SPL, R8B, R9B, R10B, R11B, R12B, R13B, R14B, R15B).
- Четыре 8-битных регистра старшего байта (AH, BH, CH, DH), адресуемые только при отсутствии префикса REX.
- Шестнадцать 16-битных регистров (AX, BX, CX, DX, DI, SI, BP, SP, R8W, R9W, R10W, R11W, R12W, R13W, R14W, R15W).
- Шестнадцать 32-битных регистров (EAX, EBX, ECX, EDX, EDI, ESI, EBP, ESP, R8D, R9D, R10D, R11D, R12D, R13D, R14D, R15D).
- Шестнадцать 64-битных регистров (RAX, RBX, RCX, RDX, RDI, RSI, RBP, RSP, R8, R9, R10, R11, R12, R13, R14, R15).

Размер регистра, используемого инструкцией, зависит от эффективного размера операнда или, для некоторых инструкций, от опкода, размера адреса или размера стека. Для большинства инструкций доступ к расширенным GPR требует префикса REX (раздел 3.5.2, «Префиксы REX», на странице 79). Четыре старших байта регистра (AH, BH, CH, DH), доступные в унаследованном режиме, не адресуются при использовании префикса REX.

Как правило, байтовые и словесные операнды хранятся в младших 8 или 16 битах GPR без модификации старших 56 или 48 бит, соответственно. Операнды двойного слова, однако, обычно хранятся в младших 32 битах GPR и расширяются до 64 бит.

64-битный регистр RFLAGS, показанный на рисунке 3-3 на странице 27, содержит унаследованный EFLAGS в его младшем 32-битном диапазоне. Старшие 32 бита зарезервированы. В них можно записать что угодно, но они всегда читаются как ноль (read as zero) (RAZ). 64-битный регистр указателя инструкций RIP содержит адрес следующей инструкции, которая должна быть выполнена, как описано в разделе 3.1.5, «Регистр указателя инструкций», на странице 36.



